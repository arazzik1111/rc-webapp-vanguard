#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const root = path.resolve(__dirname, '..');
const distDir = path.join(root, 'dist');
const target = path.join(distDir, 'index.es.js');

function log(msg) { console.log(`[ensure-index-es] ${msg}`); }
function error(msg) { console.error(`[ensure-index-es] ${msg}`); }

if (!fs.existsSync(distDir)) {
  log('dist not found, skipping');
  process.exit(0);
}

if (fs.existsSync(target)) {
  log('index.es.js already exists');
  process.exit(0);
}

// 1) Try to copy an emitted root if present
const candidates = [
  'index.js',
  'index.mjs',
  path.join('index', 'index.js'),
  path.join('index', 'index.mjs'),
  path.join('src', 'index.js'),
  path.join('src', 'index.mjs'),
];

const existingSource = candidates
  .map((rel) => path.join(distDir, rel))
  .find((p) => fs.existsSync(p));

if (existingSource) {
  fs.copyFileSync(existingSource, target);
  log(`Copied ${path.relative(distDir, existingSource)} -> index.es.js`);
  process.exit(0);
}

// 2) Fallback: generate index.es.js from src/index.ts by rewriting TS paths to .js and removing type-only exports
const srcIndex = path.join(root, 'src', 'index.ts');
if (!fs.existsSync(srcIndex)) {
  error('src/index.ts not found, cannot synthesize index.es.js');
  process.exit(1);
}

let content = fs.readFileSync(srcIndex, 'utf8');

// Remove type-only re-exports
const lines = content.split(/\r?\n/);
const outLines = [];

function rewriteImportPath(p) {
  if (!p.startsWith('.')) return p; // leave non-relative as-is
  // Replace .ts/.tsx/.mts/.cts with .js
  if (/\.(cts|mts|tsx?|d\.ts)$/.test(p)) {
    return p.replace(/\.(cts|mts|tsx?|d\.ts)$/i, '.js');
  }
  // If already .js, keep
  if (/\.js$/i.test(p)) return p;
  // Otherwise append .js
  return `${p}.js`;
}

const fromRegex = /(from\s+['"])([^'\"]+)(['"];?)/;

for (const line of lines) {
  // Skip type-only exports
  if (/^\s*export\s+type\b/.test(line)) continue;
  if (/^\s*\/\//.test(line)) { outLines.push(line); continue; }

  // Rewrite from "..." paths
  if (fromRegex.test(line)) {
    const newLine = line.replace(fromRegex, (m, pre, pth, post) => {
      return `${pre}${rewriteImportPath(pth)}${post}`;
    });
    outLines.push(newLine);
  } else {
    outLines.push(line);
  }
}

const header = `// Auto-generated by ensure-index-es.js from src/index.ts\n`;
const finalContent = header + outLines.join('\n') + '\n';

fs.writeFileSync(target, finalContent);
log('Synthesized index.es.js from src/index.ts');